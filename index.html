<script type="module" defer>
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    window.firebaseApp = null;
    window.db = null;
    window.auth = null;
    window.currentUserId = null;
    window.isAuthReady = false;

    const firebaseConfig = {
        apiKey: "AIzaSyAmp_Ymyc9j06jLK2WV_F8Ow5b8UBc2O0U", 
        authDomain: "pos-capibobba.firebaseapp.com",
        projectId: "pos-capibobba",
        storageBucket: "pos-capibobba.firebasestorage.app",
        messagingSenderId: "1016686030608",
        appId: "1:1016686030608:web:7b28ce00d347ce32403f95",
        measurementId: "G-GZY0B5FBQZ",
    };

    window.appId = firebaseConfig.projectId || 'capibobba-pos-app'; 

    if (firebaseConfig.apiKey && firebaseConfig.projectId) {
        window.firebaseApp = initializeApp(firebaseConfig);
        window.auth = getAuth(window.firebaseApp);
        window.db = getFirestore(window.firebaseApp);

        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                window.currentUserId = user.uid;
                window.isAuthReady = true;
                console.log("Firebase: Usuario autenticado. UID:", user.uid);
            } else {
                console.log("Firebase: No hay usuario autenticado. Intentando autenticación anónima...");
                try {
                    const userCredential = await signInAnonymously(window.auth);
                    window.currentUserId = userCredential.user.uid;
                    window.isAuthReady = true;
                    console.log("Firebase: Sesión anónima iniciada. UID:", window.currentUserId);
                } catch (error) {
                    console.error("Firebase: Error durante la autenticación anónima:", error);
                    window.currentUserId = null;
                    window.isAuthReady = false;
                }
            }
            // CORRECCIÓN: Eliminado el 'new' duplicado
            document.dispatchEvent(new Event('firebaseAuthReady'));
        });
    } else {
        console.error("Firebase: firebaseConfig no está completo o es inválido. La persistencia no funcionará.");
        window.isAuthReady = false;
        window.currentUserId = null;
        document.dispatchEvent(new Event('firebaseAuthReady'));
    }
</script>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta Capibobba</title>
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF69B4"> <!-- Color principal de tu aplicaci√≥n -->
    <!-- Meta tags actualizadas para iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Capibobba POS">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/FF69B4/ffffff?text=CBPOS"> <!-- Icono para iOS -->
    <!-- Nueva meta tag recomendada para iOS -->
    <meta name="mobile-web-app-capable" content="yes">


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Make Firebase instances globally available for the script below
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null; // To store the authenticated user's ID
        window.isAuthReady = false; // Flag to ensure Firestore operations wait for auth

        // Global variables provided by the Canvas environment (NO EST√ÅN DISPONIBLES EN PRODUCCI√ìN)
        // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        // const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- REEMPLAZA ESTO CON TU CONFIGURACI√ìN DE FIREBASE REAL ---
        // Puedes obtener esta configuraci√≥n desde la consola de Firebase.
        // Ejemplo:
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };
        // --- FIN DE LA CONFIGURACI√ìN DE FIREBASE ---

        // Para el ID de la aplicaci√≥n en Firestore, usa un valor fijo o el projectId si no tienes uno espec√≠fico.
        const appId = firebaseConfig.projectId || 'capibobba-pos-app'; // Usar projectId como appId si no se define uno espec√≠fico

        // El token de autenticaci√≥n inicial no se usa en despliegues p√∫blicos de esta manera.
        // Se usar√° signInAnonymously directamente.
        const initialAuthToken = null; // No aplicable para despliegue p√∫blico sin un sistema de auth m√°s complejo

        if (firebaseConfig.apiKey && firebaseConfig.projectId) { // Verifica que la configuraci√≥n sea v√°lida
            window.firebaseApp = initializeApp(firebaseConfig);
            window.auth = getAuth(window.firebaseApp);
            window.db = getFirestore(window.firebaseApp);

            // Listen for auth state changes
            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    window.currentUserId = user.uid;
                    console.log("Firebase: User authenticated. UID:", user.uid);
                } else {
                    // Sign in anonymously if no user is logged in (e.g., first time loading)
                    try {
                        // En un despliegue p√∫blico, nos autenticamos an√≥nimamente si no hay token.
                        // El token inicial solo se usa en el entorno de Canvas.
                        await signInAnonymously(window.auth);
                        window.currentUserId = window.auth.currentUser.uid;
                        console.log("Firebase: Signed in anonymously. UID:", window.currentUserId);
                    } catch (error) {
                        console.error("Firebase: Error during authentication:", error);
                        // Fallback to a random ID if authentication fails
                        window.currentUserId = crypto.randomUUID();
                        console.warn("Firebase: Using random UUID as userId due to auth failure.");
                    }
                }
                window.isAuthReady = true;
                // Once auth is ready, dispatch event to main script
                document.dispatchEvent(new Event('firebaseAuthReady'));
            });
        } else {
            console.error("Firebase: firebaseConfig no est√° completo o es inv√°lido. La persistencia no funcionar√°.");
            // If Firebase config is missing, proceed without persistence but log a warning
            window.isAuthReady = true;
            window.currentUserId = crypto.randomUUID(); // Use a random ID for local operations
            document.dispatchEvent(new Event('firebaseAuthReady'));
        }
    </script>
    <style>
        /* Importa la fuente Nunito de Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');

        /* Estilos generales */
        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 20px;
            width: 100%;
            max-width: 1200px;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 25px;
        }

        h1 {
            text-align: center;
            color: #FF69B4; /* Capibobba pink */
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 900;
            width: 100%; /* Ensure heading takes full width */
        }

        .section {
            background-color: #fdfdff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            flex: 1; /* Allow sections to grow */
            min-width: 300px; /* Minimum width for sections */
            display: flex;
            flex-direction: column;
        }

        .section-title {
            color: #9370DB; /* Purple */
            font-size: 1.8em;
            font-weight: 800;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #DDA0DD; /* Lilac border */
            padding-bottom: 10px;
        }

        /* Menu Section */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* Responsive grid */
            gap: 15px;
            flex-grow: 1; /* Allow menu to take available space */
        }

        .menu-item {
            background-color: #e0f7fa; /* Light cyan */
            border: 2px solid #87CEEB; /* Light blue */
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            background-color: #cceeff; /* Lighter blue on hover */
        }

        .item-name {
            font-weight: 700;
            font-size: 1.1em;
            color: #4b0082; /* Indigo */
            margin-bottom: 5px;
        }

        .item-price {
            font-weight: 800;
            color: #32CD32; /* Lime green */
            font-size: 1.2em;
        }

        /* Transaction Section */
        .transaction-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; /* Allow list to take available space */
            overflow-y: auto; /* Scroll for long lists */
            max-height: 400px; /* Max height for scroll */
            border: 1px dashed #B0C4DE;
            border-radius: 8px;
            padding: 10px;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid #eee;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .item-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .item-info span {
            font-size: 0.95em;
            color: #555;
        }

        .item-info .item-qty-name {
            font-weight: 700;
            color: #333;
            margin-bottom: 3px;
        }

        .item-info .item-toppings-display {
            font-size: 0.8em;
            color: #777;
            font-style: italic;
        }

        .item-total-price {
            font-weight: 800;
            color: #FF1493; /* Deep pink */
            font-size: 1.1em;
            margin-right: 10px;
            white-space: nowrap; /* Prevent wrapping */
        }

        .remove-item-btn {
            background-color: #ff6347; /* Tomato */
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s ease;
        }

        .remove-item-btn:hover {
            background-color: #ff4500; /* Orange red */
        }

        .transaction-total {
            text-align: right;
            font-size: 1.5em;
            font-weight: 900;
            color: #007BFF; /* Blue */
            margin-top: 20px;
            padding-top: 10px;
            border-top: 2px solid #B0C4DE;
        }

        .transaction-actions {
            display: flex;
            flex-direction: column; /* Stack buttons vertically */
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            align-items: center; /* Center buttons horizontally */
        }

        .action-button {
            background-color: #28a745; /* Green */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%; /* Make buttons take full width */
            max-width: 250px; /* Limit max width for larger screens */
        }

        .action-button.clear {
            background-color: #dc3545; /* Red */
        }

        .action-button.whatsapp {
            background-color: #25D366; /* WhatsApp Green */
        }

        .action-button:hover {
            opacity: 0.9;
        }

        /* Daily Sales Section */
        .daily-sales-section {
            margin-top: 30px;
            width: 100%;
            max-width: 1200px;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 25px;
        }

        .filter-toggle-container {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Align to start */
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .filter-toggle-container label {
            font-weight: 700;
            color: #4b0082;
            margin-right: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #9370DB; /* Purple when active */
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #9370DB;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(22px);
            -ms-transform: translateX(22px);
            transform: translateX(22px);
        }

        /* Hide filter controls by default */
        .sales-filter-controls.hidden {
            display: none;
        }

        .sales-filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px dashed #DDA0DD;
            border-radius: 10px;
            justify-content: center;
            align-items: center;
            background-color: #fcfcfc;
        }

        .sales-filter-controls label {
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }

        .sales-filter-controls input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: 'Nunito', sans-serif;
            font-size: 1em;
            flex-grow: 1; /* Allow input to grow */
            max-width: 180px; /* Limit width */
        }

        .sales-filter-controls button {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: white;
        }

        .sales-filter-controls button.filter {
            background-color: #007BFF; /* Blue */
        }
        .sales-filter-controls button.filter:hover {
            background-color: #0056b3;
        }
        .sales-filter-controls button.clear-filter {
            background-color: #6c757d; /* Gray */
        }
        .sales-filter-controls button.clear-filter:hover {
            background-color: #5a6268;
        }


        .sales-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px dashed #B0C4DE;
            border-radius: 8px;
            padding: 10px;
        }

        .sale-item {
            background-color: #f8f9fa; /* Light gray */
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative; /* For action buttons positioning */
        }

        .sale-item:last-child {
            margin-bottom: 0;
        }

        .sale-header {
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            margin-bottom: 5px;
            color: #6c757d;
            font-size: 0.9em;
        }

        .sale-details {
            font-size: 0.9em;
            color: #495057;
            margin-bottom: 5px;
        }

        .sale-details ul {
            list-style: disc;
            margin-left: 20px;
            padding: 0;
        }

        .sale-details li {
            margin-bottom: 3px;
        }

        .sale-total {
            font-weight: 800;
            color: #28a745; /* Green for total */
            font-size: 1.1em;
            text-align: right;
            border-top: 1px dashed #ced4da;
            padding-top: 5px;
            margin-top: 5px;
        }

        .sale-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .sale-action-btn {
            background-color: #9370DB; /* Purple */
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s ease;
        }

        .sale-action-btn.delete {
            background-color: #dc3545; /* Red */
        }

        .sale-action-btn:hover {
            opacity: 0.9;
        }

        /* Sales Reports Section */
        .sales-reports-section {
            margin-top: 30px;
            width: 100%;
            max-width: 1200px;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 25px;
        }

        .report-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .report-buttons button {
            background-color: #6A5ACD; /* Slate Blue */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .report-buttons button:hover {
            background-color: #483D8B; /* Dark Slate Blue */
        }

        .report-content {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .report-content h3 {
            color: #9370DB;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.4em;
            text-align: center;
        }

        .report-content ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .report-content li {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            font-size: 1em;
            color: #333;
        }

        .report-content li:last-child {
            border-bottom: none;
        }

        .report-content li span:first-child {
            font-weight: 600;
            color: #555;
        }

        .report-content li span:last-child {
            font-weight: 800;
            color: #28a745;
        }


        /* Modal for messages */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease; /* Added transform */
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px); /* Initial transform for animation */
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0); /* End transform for animation */
        }

        .modal-content h3 {
            color: #FF69B4;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .modal-content p {
            margin-bottom: 25px;
            color: #555;
        }

        .modal-content button {
            background-color: #9370DB;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }

        .modal-content button:hover {
            background-color: #87CEEB;
        }

        /* Confirmation Modal Specific Styles */
        #confirmModalOverlay .modal-content button {
            margin: 0 10px;
            padding: 10px 25px;
        }
        #confirmModalOverlay #confirmNoButton {
            background-color: #6c757d; /* Gray for No */
        }
        #confirmModalOverlay #confirmNoButton:hover {
            background-color: #5a6268;
        }
        #confirmModalOverlay #confirmYesButton {
            background-color: #dc3545; /* Red for Yes (delete) or Green (confirm) */
        }
        #confirmModalOverlay #confirmYesButton:hover {
            background-color: #c82333;
        }


        /* Topping Selection Modal Styles */
        #toppingSelectionOverlay {
            position: fixed; /* Fixed on screen */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Semi-transparent dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Higher than message modal */
            opacity: 0; /* Initially hidden */
            pointer-events: none; /* Not interactable when hidden */
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; /* Smooth transition for showing/hiding */
        }

        #toppingSelectionOverlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .topping-selection-content {
            background: rgba(255, 255, 255, 0.95); /* Almost opaque white background */
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            border: 4px solid #FF69B4; /* Vibrant pink border */
            max-width: 450px;
            width: 90%; /* Fluid width */
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        #toppingSelectionOverlay.show .topping-selection-content {
            transform: scale(1);
            opacity: 1;
        }

        .topping-selection-content .section-title {
            color: #9370DB;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .current-drink-name-modal {
            font-size: 1.2em;
            font-weight: 700;
            color: #FF69B4;
            margin-bottom: 20px;
        }

        .toppings-modal-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px dashed #DDA0DD;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.8);
        }

        .topping-modal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #F9F0FF;
            border-radius: 12px;
            padding: 12px 15px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
        }
        .topping-modal-item.selected {
            border: 2px solid #9370DB;
            background: #E6E6FA;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        .topping-modal-name {
            font-size: 1.1em;
            font-weight: 700;
            color: #9370DB;
            flex-grow: 1;
            text-align: left;
        }

        .topping-modal-price {
            font-size: 1em;
            font-weight: 600;
            color: #32CD32;
            margin-left: 10px;
            white-space: nowrap;
        }

        .add-topping-button {
            background: linear-gradient(45deg, #00CED1, #87CEEB);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 0.9em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .add-topping-button.remove {
            background: linear-gradient(45deg, #FF6347, #FF4500);
        }

        .add-topping-button:hover {
            transform: scale(1.03);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }

        .topping-selection-actions {
            margin-top: 30px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }

        .topping-selection-actions button {
            font-size: 1em;
            padding: 12px 20px;
            border-radius: 18px;
            border: 2px solid white;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .topping-selection-actions button:hover {
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        #confirmToppingsButton {
            background: linear-gradient(45deg, #25D366, #128C7E);
        }
        #confirmToppingsButton:hover {
            background: linear-gradient(45deg, #128C7E, #25D366);
        }

        #noToppingsButton {
            background: linear-gradient(45deg, #FFA500, #FFD700);
        }
        #noToppingsButton:hover {
            background: linear-gradient(45deg, #FFD700, #FFA500);
        }

        #cancelToppingsButton {
            background: linear-gradient(45deg, #FF69B4, #FF1493);
        }
        #cancelToppingsButton:hover {
            background: linear-gradient(45deg, #FF1493, #FF69B4);
        }

        /* Quantity input styling */
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 25px;
            margin-bottom: 15px;
            gap: 10px;
            font-size: 1.1em;
            font-weight: 700;
            color: #4b0082;
        }

        .quantity-control input[type="number"] {
            width: 70px;
            padding: 8px;
            border: 2px solid #DDA0DD;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1em;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            color: #333;
            -moz-appearance: textfield;
        }

        .quantity-control input[type="number"]::-webkit-outer-spin-button,
        .quantity-control input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .quantity-control button {
            background-color: #87CEEB;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.5em;
            font-weight: 900;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .quantity-control button:hover {
            background-color: #00CED1;
            transform: scale(1.05);
        }
        .quantity-control button:active {
            transform: scale(0.95);
        }

        .topping-modal-total { /* NEW STYLE */
            font-size: 1.3em;
            font-weight: 800;
            color: #007BFF;
            margin-top: 15px;
            border-top: 1px dashed #DDA0DD;
            padding-top: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 15px;
            }

            .section {
                min-width: unset;
                width: 100%;
            }

            .menu-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            h1 {
                font-size: 2em;
            }

            .section-title {
                font-size: 1.5em;
            }

            .action-button {
                width: 100%;
            }
            .transaction-actions {
                flex-direction: column;
            }

            .topping-selection-content {
                padding: 20px;
            }
            .topping-modal-name, .topping-modal-price {
                font-size: 0.9em;
            }
            .add-topping-button {
                padding: 6px 10px;
                font-size: 0.8em;
            }
            .topping-selection-actions button {
                font-size: 0.9em;
                padding: 10px 15px;
            }
            .sales-filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .sales-filter-controls input[type="date"],
            .sales-filter-controls button {
                max-width: 100%;
            }
            .report-buttons {
                flex-direction: column;
            }
            .report-buttons button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>Punto de Venta Capibobba üßã‚ú®</h1>

    <div class="container">
        <!-- Secci√≥n de Men√∫ de Productos -->
        <div class="section menu-section">
            <h2 class="section-title">Men√∫ de Productos üìã</h2>
            <div class="menu-grid" id="menuGrid">
                <!-- Los productos se cargar√°n aqu√≠ din√°micamente con JavaScript -->
            </div>
        </div>

        <!-- Secci√≥n de Transacci√≥n Actual -->
        <div class="section transaction-section">
            <h2 class="section-title">Transacci√≥n Actual üõí</h2>
            <ul class="transaction-list" id="transactionList">
                <!-- Los √≠tems de la transacci√≥n se cargar√°n aqu√≠ din√°micamente -->
                <li style="text-align: center; color: #6b7280;">¬°A√±ade productos para empezar!</li>
            </ul>
            <div class="transaction-total" id="transactionTotal">Total: $0.00</div>
            <div class="transaction-actions">
                <!-- Nuevo bot√≥n para confirmaci√≥n por WhatsApp -->
                <button class="action-button whatsapp" id="whatsappConfirmationButton">Confirmaci√≥n de pedido üì±</button>
                <button class="action-button" id="completeSaleButton">Pagar ‚úÖ</button>
                <button class="action-button clear" id="clearTransactionButton">Vaciar Transacci√≥n üóëÔ∏è</button>
            </div>
        </div>
    </div>

    <!-- Secci√≥n de Registro de Ventas Diarias -->
    <div class="daily-sales-section">
        <h2 class="section-title">Registro de Ventas Diarias üìà</h2>
        
        <!-- Controles de filtro -->
        <div class="filter-toggle-container">
            <label for="toggleFilterCheckbox">Activar Filtro de Fechas:</label>
            <label class="switch">
                <input type="checkbox" id="toggleFilterCheckbox">
                <span class="slider"></span>
            </label>
        </div>

        <div class="sales-filter-controls hidden" id="salesFilterControlsContainer">
            <label for="startDateInput">Desde:</label>
            <input type="date" id="startDateInput">
            <label for="endDateInput">Hasta:</label>
            <input type="date" id="endDateInput">
            <button class="filter" id="applyFilterButton">Filtrar</button>
            <button class="clear-filter" id="clearFilterButton">Limpiar Filtro</button>
        </div>

        <ul class="sales-list" id="dailySalesList">
            <!-- Las ventas diarias se cargar√°n aqu√≠ din√°micamente -->
            <li style="text-align: center; color: #6b7280;">No hay ventas registradas hoy.</li>
        </ul>
    </div>

    <!-- Secci√≥n de Informes de Ventas -->
    <div class="sales-reports-section">
        <h2 class="section-title">Informes de Ventas üìä</h2>
        <div class="report-buttons">
            <button id="dailyReportButton">Informe Diario</button>
            <button id="weeklyReportButton">Informe Semanal</button>
            <button id="monthlyReportButton">Informe Mensual</button>
        </div>
        <div class="report-content" id="reportContent">
            <p style="text-align: center; color: #6b7280;">Selecciona un tipo de informe para ver los resultados.</p>
        </div>
    </div>


    <!-- Modal para mensajes -->
    <div id="messageModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <button id="modalCloseButton">Aceptar</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirmTitle"></h3>
            <p id="confirmMessage"></p>
            <button id="confirmYesButton">S√≠</button>
            <button id="confirmNoButton">No</button>
        </div>
    </div>

    <!-- Topping Selection Modal -->
    <div id="toppingSelectionOverlay" class="modal-overlay">
        <div class="topping-selection-content">
            <div class="section-header">
                <div class="section-title">¬°Personaliza tu <span id="toppingDrinkName" class="current-drink-name-modal"></span>!</div>
                <p>Selecciona los toppings que deseas a√±adir a esta bebida:</p>
            </div>
            <div id="toppingsModalGrid" class="toppings-modal-grid">
                <!-- Toppings will be dynamically loaded here by JS -->
            </div>

            <!-- Quantity input for the drink -->
            <div class="quantity-control">
                <label for="drinkQuantity">Cantidad:</label>
                <button id="decrementQuantity">-</button>
                <input type="number" id="drinkQuantity" value="1" min="1">
                <button id="incrementQuantity">+</button>
            </div>

            <div class="topping-modal-total">
                Total: $<span id="toppingModalTotalPrice">0.00</span>
            </div>

            <div class="topping-selection-actions">
                <button id="confirmToppingsButton">Confirmar Selecci√≥n ‚úÖ</button>
                <button id="noToppingsButton">Sin Toppings üö´</button>
                <button id="cancelToppingsButton">Cancelar ‚ùå</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Register Service Worker (NEW PWA CODE)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado con √©xito:', registration);
                    })
                    .catch(error => {
                        console.error('Fallo el registro del Service Worker:', error);
                    });
            });
        }

        // Import Firebase modules (already imported in the <script type="module"> block above)
        import { collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Access global Firebase instances set up in the first script tag
        const firebaseApp = window.firebaseApp;
        const db = window.db;
        const auth = window.auth;
        // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Re-access appId
        // Ahora appId se define arriba con firebaseConfig.projectId

        let currentUserId = window.currentUserId; // Will be updated by the onAuthStateChanged listener
        let isAuthReady = window.isAuthReady; // Flag from the global script

        // In-memory data storage for the POS system
        let menuItems = []; // All available products (drinks and toppings)
        let availableToppings = []; // Separate array for toppings
        let currentTransaction = []; // Items currently in the transaction
        let dailySales = []; // Completed sales for the day (now synced with Firestore)
        let editingSaleDocId = null; // Stores the Firestore document ID of the sale being edited

        let currentDrinkBeingCustomized = null; // Stores the drink object while toppings are being selected

        // DOM Elements
        const menuGrid = document.getElementById('menuGrid');
        const transactionList = document.getElementById('transactionList');
        const transactionTotalElement = document.getElementById('transactionTotal');
        const completeSaleButton = document.getElementById('completeSaleButton');
        const clearTransactionButton = document.getElementById('clearTransactionButton');
        const whatsappConfirmationButton = document.getElementById('whatsappConfirmationButton');
        const dailySalesList = document.getElementById('dailySalesList');
        const messageModalOverlay = document.getElementById('messageModalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseButton = document.getElementById('modalCloseButton');

        // Confirmation Modal Elements
        const confirmModalOverlay = document.getElementById('confirmModalOverlay');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmYesButton = document.getElementById('confirmYesButton');
        const confirmNoButton = document.getElementById('confirmNoButton');

        // Topping Modal Elements
        const toppingSelectionOverlay = document.getElementById('toppingSelectionOverlay');
        const toppingDrinkNameElement = document.getElementById('toppingDrinkName');
        const toppingsModalGrid = document.getElementById('toppingsModalGrid');
        const confirmToppingsButton = document.getElementById('confirmToppingsButton');
        const noToppingsButton = document.getElementById('noToppingsButton');
        const cancelToppingsButton = document.getElementById('cancelToppingsButton');
        const drinkQuantityInput = document.getElementById('drinkQuantity');
        const decrementQuantityButton = document.getElementById('decrementQuantity');
        const incrementQuantityButton = document.getElementById('incrementQuantity');
        const toppingModalTotalPriceElement = document.getElementById('toppingModalTotalPrice');

        // Filter Elements
        const toggleFilterCheckbox = document.getElementById('toggleFilterCheckbox');
        const salesFilterControlsContainer = document.getElementById('salesFilterControlsContainer');
        const startDateInput = document.getElementById('startDateInput');
        const endDateInput = document.getElementById('endDateInput');
        const applyFilterButton = document.getElementById('applyFilterButton');
        const clearFilterButton = document.getElementById('clearFilterButton');

        let isFilterEnabled = false; // Controls if the date filter is active

        // Report Elements
        const dailyReportButton = document.getElementById('dailyReportButton');
        const weeklyReportButton = document.getElementById('weeklyReportButton');
        const monthlyReportButton = document.getElementById('monthlyReportButton');
        const reportContent = document.getElementById('reportContent');


        // --- Data Initialization ---
        function initializeData() {
            // Define menu items (only drinks here)
            menuItems = [
                // Frapp√©s base agua
                { id: 'water-litchi', name: 'Frapp√© Litchi (Agua)', price: 75, type: 'drink' },
                { id: 'water-fresa', name: 'Frapp√© Fresa (Agua)', price: 75, type: 'drink' },
                { id: 'water-blueberry', name: 'Frapp√© Blueberry (Agua)', price: 75, type: 'drink' },
                { id: 'water-mango', name: 'Frapp√© Mango (Agua)', price: 75, type: 'drink' },
                { id: 'water-pina-colada', name: 'Frapp√© Pi√±a Colada (Agua)', price: 75, type: 'drink' },
                { id: 'water-maracuya', name: 'Frapp√© Maracuy√° (Agua)', price: 75, type: 'drink' },
                { id: 'water-guanabana', name: 'Frapp√© Guan√°bana (Agua)', price: 75, type: 'drink' },
                { id: 'water-sandia', name: 'Frapp√© Sand√≠a (Agua)', price: 75, type: 'drink' },
                // Frapp√©s base leche
                { id: 'milk-choco-mexicano', name: 'Frapp√© Chocolate Mexicano (Leche)', price: 75, type: 'drink' },
                { id: 'milk-taro', name: 'Frapp√© Taro (Leche)', price: 75, type: 'drink' },
                { id: 'milk-mazapan', name: 'Frapp√© Mazap√°n (Leche)', price: 75, type: 'drink' },
                { id: 'milk-chai', name: 'Frapp√© Chai (Leche)', price: 75, type: 'drink' },
                { id: 'milk-mocha', name: 'Frapp√© Mocha (Leche)', price: 75, type: 'drink' },
                { id: 'milk-cookies-cream', name: 'Frapp√© Cookies & Cream (Leche)', price: 75, type: 'drink' },
                { id: 'milk-crema-irlandesa', name: 'Frapp√© Crema Irlandesa (Leche)', price: 75, type: 'drink' },
                { id: 'milk-matcha', name: 'Frapp√© Matcha (Leche)', price: 75, type: 'drink' },
                // Bebidas Calientes
                { id: 'hot-chocolate', name: 'Chocolate Caliente', price: 60, type: 'drink' },
                { id: 'hot-taro', name: 'Taro Caliente', price: 60, type: 'drink' },
                { id: 'hot-mazapan', name: 'Mazap√°n Caliente', price: 60, type: 'drink' },
                { id: 'hot-chai', name: 'Chai Caliente', price: 60, type: 'drink' },
                { id: 'hot-mocha', name: 'Mocha Caliente', price: 60, type: 'drink' },
                { id: 'hot-cookies-cream', name: 'Cookies & Cream Caliente', price: 60, type: 'drink' },
                { id: 'hot-crema-irlandesa', name: 'Crema Irlandesa Caliente', price: 60, type: 'drink' },
                { id: 'hot-matcha', name: 'Matcha Caliente', price: 60, type: 'drink' },
                // Promociones (tratadas como bebidas por ahora)
                { id: 'promo-fresas-crema', name: 'Frapp√© Fresas con Crema (Temporada)', price: 75, type: 'drink' },
            ];

            // Define available toppings separately
            availableToppings = [
                { id: 'topping-frutos-rojos', name: 'Perlas explosivas de frutos rojos', price: 10 },
                { id: 'topping-manzana-verde', name: 'Perlas explosivas de manzana verde', price: 10 },
                { id: 'topping-litchi', name: 'Perlas explosivas de litchi', price: 10 },
                { id: 'topping-arcoiris', name: 'Jelly arcoiris', price: 10 },
            ];
        }

        // --- UI Rendering Functions ---

        // Renders all menu items (drinks) in the menu grid
        function renderMenu() {
            menuGrid.innerHTML = ''; // Clear existing items
            menuItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `menu-item ${item.type}`; // Add type class for specific styling
                itemDiv.dataset.itemId = item.id;
                itemDiv.innerHTML = `
                    <span class="item-name">${item.name}</span>
                    <span class="item-price">$${item.price.toFixed(2)}</span>
                `;
                // When a drink is clicked, open the topping selection modal
                itemDiv.addEventListener('click', () => openToppingSelectionModal(item));
                menuGrid.appendChild(itemDiv);
            });
        }

        // Updates the transaction list and total display
        function updateTransactionDisplay() {
            transactionList.innerHTML = ''; // Clear existing items
            let total = 0;

            if (currentTransaction.length === 0) {
                transactionList.innerHTML = '<li style="text-align: center; color: #6b7280;">¬°A√±ade productos para empezar!</li>';
            } else {
                // Iterate directly over currentTransaction as it now holds grouped items with quantities
                currentTransaction.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'transaction-item';

                    let toppingsDisplay = '';
                    let toppingsPrice = 0;
                    if (item.toppings && item.toppings.length > 0) {
                        toppingsDisplay = `<span class="item-toppings-display">(+ ${item.toppings.map(t => t.name).join(', ')})</span>`;
                        toppingsPrice = item.toppings.reduce((sum, t) => sum + t.price, 0);
                    }

                    const itemSubtotal = (item.price + toppingsPrice) * item.quantity;
                    total += itemSubtotal;

                    // The data-item-key for removal should be the unique transactionLineId
                    li.innerHTML = `
                        <div class="item-info">
                            <span class="item-qty-name">${item.quantity}x ${item.name}</span>
                            ${toppingsDisplay}
                        </div>
                        <span class="item-total-price">$${itemSubtotal.toFixed(2)}</span>
                        <button class="remove-item-btn" data-transaction-line-id="${item.transactionLineId}">‚ûñ</button>
                    `;
                    transactionList.appendChild(li);
                });
            }

            transactionTotalElement.textContent = `Total: $${total.toFixed(2)}`;

            // Update button text based on editing mode
            if (editingSaleDocId) {
                completeSaleButton.textContent = 'Actualizar Venta ‚úÖ';
                clearTransactionButton.textContent = 'Cancelar Edici√≥n ‚ùå';
            } else {
                completeSaleButton.textContent = 'Pagar ‚úÖ';
                clearTransactionButton.textContent = 'Vaciar Transacci√≥n üóëÔ∏è';
            }


            // Add event listeners for remove buttons
            transactionList.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const transactionLineIdToRemove = event.target.dataset.transactionLineId;
                    decrementItemQuantity(transactionLineIdToRemove); // Call decrement function
                });
            });
        }

        // Renders the list of completed daily sales from the `dailySales` array or a filtered array
        function renderDailySales(salesToRender = dailySales) { // Accepts optional argument
            dailySalesList.innerHTML = ''; // Clear existing sales
            if (salesToRender.length === 0) {
                dailySalesList.innerHTML = '<li style="text-align: center; color: #6b7280;">No hay ventas registradas hoy.</li>';
                return;
            }

            // Sort sales by timestamp in descending order (most recent first)
            const sortedSales = [...salesToRender].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            sortedSales.forEach((sale, index) => {
                const saleItemDiv = document.createElement('li');
                saleItemDiv.className = 'sale-item';

                const saleDate = new Date(sale.timestamp).toLocaleString();
                let saleDetailsHtml = '<ul>';
                sale.items.forEach(item => { // items here are already grouped with quantities
                    let toppingsDetail = '';
                    let toppingsPrice = 0;
                    if (item.toppings && item.toppings.length > 0) {
                        toppingsDetail = ` (+ ${item.toppings.map(t => t.name).join(', ')})`;
                        toppingsPrice = item.toppings.reduce((sum, t) => sum + t.price, 0);
                    }
                    saleDetailsHtml += `<li>${item.quantity}x ${item.name}${toppingsDetail} ($${(item.price + toppingsPrice).toFixed(2)} c/u)</li>`;
                });
                saleDetailsHtml += '</ul>';

                saleItemDiv.innerHTML = `
                    <div class="sale-header">
                        <span>Venta #${sortedSales.length - index}</span> <!-- Display sale number in ascending order -->
                        <span>${saleDate}</span>
                    </div>
                    <div class="sale-details">
                        ${saleDetailsHtml}
                    </div>
                    <div class="sale-total">Total Venta: $${sale.total.toFixed(2)}</div>
                    <div class="sale-actions">
                        <button class="sale-action-btn edit" data-sale-id="${sale.id}">‚úèÔ∏è</button>
                        <button class="sale-action-btn delete" data-sale-id="${sale.id}">üóëÔ∏è</button>
                    </div>
                `;
                dailySalesList.appendChild(saleItemDiv);
            });

            // Add event listeners for new edit/delete buttons
            dailySalesList.querySelectorAll('.sale-action-btn.edit').forEach(button => {
                button.addEventListener('click', (event) => {
                    editSale(event.target.dataset.saleId);
                });
            });
            dailySalesList.querySelectorAll('.sale-action-btn.delete').forEach(button => {
                button.addEventListener('click', (event) => {
                    // Use confirmation modal for deletion
                    const saleIdToDelete = event.target.dataset.saleId;
                    showConfirm('Confirmar Eliminaci√≥n', '¬øEst√°s seguro de que quieres eliminar esta venta del historial?', () => {
                        deleteSale(saleIdToDelete);
                    });
                });
            });
        }

        // --- Transaction Logic Functions ---

        // Calculates the total price for the current drink being customized
        function calculateToppingModalTotalPrice() {
            if (!currentDrinkBeingCustomized) return 0;

            let basePrice = currentDrinkBeingCustomized.price;
            let toppingsPrice = currentDrinkBeingCustomized.selectedToppings.reduce((sum, t) => sum + t.price, 0);
            let quantity = parseInt(drinkQuantityInput.value, 10);
            if (isNaN(quantity) || quantity < 1) quantity = 1; // Default to 1 if invalid

            return (basePrice + toppingsPrice) * quantity;
        }

        // Updates the total price display in the topping modal
        function updateToppingModalTotalPriceDisplay() {
            const total = calculateToppingModalTotalPrice();
            toppingModalTotalPriceElement.textContent = total.toFixed(2);
        }


        // Opens the topping selection modal for a given drink
        function openToppingSelectionModal(drinkItem) {
            // Initialize currentDrinkBeingCustomized with the base drink and default quantity
            currentDrinkBeingCustomized = {
                ...drinkItem,
                selectedToppings: [], // Toppings selected in the modal
                quantity: 1 // Default quantity
            };

            toppingDrinkNameElement.textContent = drinkItem.name;
            toppingsModalGrid.innerHTML = ''; // Clear previous toppings
            drinkQuantityInput.value = 1; // Reset quantity input

            // Populate toppings in the modal
            availableToppings.forEach(topping => {
                const toppingItemDiv = document.createElement('div');
                toppingItemDiv.className = 'topping-modal-item';
                toppingItemDiv.dataset.toppingId = topping.id; // Use ID for easier lookup
                toppingItemDiv.dataset.toppingName = topping.name;
                toppingItemDiv.dataset.toppingPrice = topping.price;

                toppingItemDiv.innerHTML = `
                    <span class="topping-modal-name">${topping.name}</span>
                    <span class="topping-modal-price">+$${topping.price.toFixed(2)}</span>
                    <button class="add-topping-button" data-action="add">A√±adir ‚ú®</button>
                `;
                // Event listener to toggle topping selection
                toppingItemDiv.addEventListener('click', function(event) {
                    // Prevent button click from triggering item click if clicked directly on button
                    if (event.target.tagName === 'BUTTON') {
                        return;
                    }
                    const button = this.querySelector('.add-topping-button');
                    button.click(); // Simulate a click on the button to toggle state
                });
                toppingsModalGrid.appendChild(toppingItemDiv);
            });

            // Attach event listeners for topping buttons in the modal
            toppingsModalGrid.querySelectorAll('.add-topping-button').forEach(button => {
                button.addEventListener('click', function() {
                    const toppingItemDiv = this.closest('.topping-modal-item');
                    const toppingId = toppingItemDiv.dataset.toppingId;
                    const toppingName = toppingItemDiv.dataset.toppingName;
                    const toppingPrice = parseFloat(toppingItemDiv.dataset.toppingPrice);

                    const existingToppingIndex = currentDrinkBeingCustomized.selectedToppings.findIndex(t => t.id === toppingId);

                    if (existingToppingIndex === -1) { // Topping not selected, add it
                        currentDrinkBeingCustomized.selectedToppings.push({ id: toppingId, name: toppingName, price: toppingPrice });
                        toppingItemDiv.classList.add('selected');
                        this.textContent = 'Quitar ‚ûñ';
                        this.dataset.action = 'remove';
                        this.classList.add('remove');
                    } else { // Topping already selected, remove it
                        currentDrinkBeingCustomized.selectedToppings.splice(existingToppingIndex, 1);
                        toppingItemDiv.classList.remove('selected');
                        this.textContent = 'A√±adir ‚ú®';
                        this.dataset.action = 'add';
                        this.classList.remove('remove');
                    }
                    updateToppingModalTotalPriceDisplay(); // Update price when toppings change
                });
            });

            updateToppingModalTotalPriceDisplay(); // Initial price display
            toppingSelectionOverlay.classList.add('show');
        }

        // Adds the customized drink (with its selected toppings and quantity) to the transaction
        function addCustomizedDrinkToTransaction() {
            if (currentDrinkBeingCustomized) {
                const quantity = parseInt(drinkQuantityInput.value, 10);
                if (isNaN(quantity) || quantity < 1) {
                    showMessage('Cantidad Inv√°lida', 'Por favor, introduce una cantidad v√°lida (m√≠nimo 1).');
                    return;
                }

                // Update the quantity in the currentDrinkBeingCustomized object
                currentDrinkBeingCustomized.quantity = quantity;

                // Create a unique key for this specific drink + toppings combination
                const toppingIds = currentDrinkBeingCustomized.selectedToppings.map(t => t.id).sort().join(',');
                const uniqueKey = `${currentDrinkBeingCustomized.id}-${toppingIds}`;

                // Check if an identical item (same drink, same toppings) already exists in the transaction
                const existingTransactionItemIndex = currentTransaction.findIndex(item => {
                    const existingToppingIds = item.toppings ? item.toppings.map(t => t.id).sort().join(',') : '';
                    return item.id === currentDrinkBeingCustomized.id && existingToppingIds === toppingIds;
                });

                if (existingTransactionItemIndex > -1) {
                    // If it exists, just update its quantity
                    currentTransaction[existingTransactionItemIndex].quantity += quantity;
                } else {
                    // If it's a new combination, add it as a new line item
                    const transactionItem = {
                        ...currentDrinkBeingCustomized,
                        toppings: [...currentDrinkBeingCustomized.selectedToppings], // Deep copy toppings
                        transactionLineId: uniqueKey // Use this as the unique ID for the line item
                    };
                    delete transactionItem.selectedToppings; // Clean up temp property
                    currentTransaction.push(transactionItem);
                }

                currentDrinkBeingCustomized = null; // Clear the temporary drink
                toppingSelectionOverlay.classList.remove('show'); // Hide modal
                updateTransactionDisplay();
                showMessage('Producto A√±adido', `Se a√±adieron ${quantity}x ${currentDrinkBeingCustomized.name} a la transacci√≥n.`);
            }
        }

        // Decrements the quantity of an item in the current transaction, or removes it if quantity is 1
        function decrementItemQuantity(transactionLineId) {
            const itemIndex = currentTransaction.findIndex(item => item.transactionLineId === transactionLineId);

            if (itemIndex > -1) {
                if (currentTransaction[itemIndex].quantity > 1) {
                    currentTransaction[itemIndex].quantity--;
                    showMessage('Cantidad Actualizada', `Cantidad de ${currentTransaction[itemIndex].name} reducida.`);
                } else {
                    const removedItemName = currentTransaction[itemIndex].name;
                    currentTransaction.splice(itemIndex, 1); // Remove the item if quantity is 1
                    showMessage('Producto Eliminado', `${removedItemName} ha sido eliminado de la transacci√≥n.`);
                }
                updateTransactionDisplay();
            }
        }


        // Completes the current sale and adds it to daily sales (Firestore)
        // Or updates an existing sale if in editing mode
        async function completeSale() {
            if (currentTransaction.length === 0) {
                showMessage('Transacci√≥n Vac√≠a', 'No hay productos en la transacci√≥n para completar la venta.');
                return;
            }

            // Check Firebase readiness and user ID
            if (!window.isAuthReady || !window.db || !window.currentUserId) {
                console.error("Firebase: DB or User ID not ready.", { isAuthReady: window.isAuthReady, db: window.db, currentUserId: window.currentUserId });
                showMessage('Error de Autenticaci√≥n', 'Firebase no est√° listo o el ID de usuario no est√° disponible. Por favor, espera un momento o recarga la p√°gina.');
                return;
            }

            const total = parseFloat(transactionTotalElement.textContent.replace('Total: $', ''));

            // The items in currentTransaction are already grouped with quantities, so just copy them
            const saleData = {
                timestamp: new Date().toISOString(),
                items: JSON.parse(JSON.stringify(currentTransaction)), // Deep copy of items
                total: total
            };

            try {
                // Usa la variable appId definida globalmente en el script de Firebase
                const salesCollectionRef = collection(window.db, `artifacts/${window.appId}/users/${window.currentUserId}/dailySales`);

                if (editingSaleDocId) {
                    // Update existing document
                    const saleDocRef = doc(salesCollectionRef, editingSaleDocId);
                    await setDoc(saleDocRef, saleData, { merge: false }); // Overwrite the entire document
                    console.log("Document updated with ID: ", editingSaleDocId);
                    showMessage('Venta Actualizada', `Venta por $${total.toFixed(2)} actualizada con √©xito en la base de datos.`);
                    editingSaleDocId = null; // Exit editing mode
                } else {
                    // Add new document
                    const docRef = await addDoc(salesCollectionRef, saleData);
                    console.log("Document written with ID: ", docRef.id);
                    showMessage('Venta Registrada', `Venta por $${total.toFixed(2)} registrada con √©xito en la base de datos.`);
                }
                
                currentTransaction = []; // Clear current transaction locally
                updateTransactionDisplay(); // This will also reset button text
                // renderDailySales will be triggered by onSnapshot listener
            } catch (error) {
                console.error("Error saving document to Firestore: ", error);
                showMessage('Error al Guardar Venta', `Hubo un problema al guardar la venta: ${error.message}. Por favor, revisa la consola para m√°s detalles y tus reglas de seguridad de Firestore.`);
            }
        }

        // Clears the current transaction and exits editing mode if active
        function clearTransaction() {
            if (currentTransaction.length === 0 && !editingSaleDocId) {
                showMessage('Transacci√≥n Vac√≠a', 'La transacci√≥n ya est√° vac√≠a.');
                return;
            }

            showConfirm('Confirmar Vaciado', '¬øEst√°s seguro de que quieres vaciar la transacci√≥n actual?', () => {
                currentTransaction = [];
                editingSaleDocId = null; // Exit editing mode
                updateTransactionDisplay(); // This will reset button text
                showMessage('Transacci√≥n Vaciada', 'Todos los productos han sido eliminados de la transacci√≥n.');
            });
        }

        // --- Functions for Editing/Deleting Sales ---

        // Deletes a sale from Firestore
        async function deleteSale(saleId) {
            if (!window.isAuthReady || !window.db || !window.currentUserId) {
                showMessage('Error de Autenticaci√≥n', 'Firebase no est√° listo o el ID de usuario no est√° disponible.');
                return;
            }

            try {
                // Usa la variable appId definida globalmente en el script de Firebase
                const saleDocRef = doc(window.db, `artifacts/${window.appId}/users/${window.currentUserId}/dailySales`, saleId);
                await deleteDoc(saleDocRef);
                console.log("Document successfully deleted with ID: ", saleId);
                showMessage('Venta Eliminada', 'La venta ha sido eliminada del historial.');
                // onSnapshot will automatically re-render dailySalesList
            } catch (error) {
                console.error("Error removing document: ", error);
                showMessage('Error al Eliminar Venta', `Hubo un problema al eliminar la venta: ${error.message}.`);
            }
        }

        // Loads a sale into the current transaction for editing
        function editSale(saleId) {
            const saleToEdit = dailySales.find(sale => sale.id === saleId);
            if (saleToEdit) {
                currentTransaction = JSON.parse(JSON.stringify(saleToEdit.items)); // Deep copy items
                editingSaleDocId = saleId; // Set editing mode
                updateTransactionDisplay(); // Update UI and button text
                showMessage('Modo Edici√≥n', `Editando venta #${dailySales.findIndex(s => s.id === saleId) + 1}. Realiza cambios y haz clic en "Actualizar Venta".`);
            } else {
                showMessage('Venta No Encontrada', 'No se pudo encontrar la venta para editar.');
            }
        }

        // --- Functions for Filtering Sales ---
        function applySalesFilter() {
            if (!isFilterEnabled) {
                // If filter is disabled, just ensure all sales are rendered
                renderDailySales(dailySales); 
                return;
            }

            const startDateStr = startDateInput.value;
            const endDateStr = endDateInput.value;

            if (!startDateStr && !endDateStr) {
                showMessage('Filtro Vac√≠o', 'Por favor, selecciona al menos una fecha para filtrar.');
                renderDailySales(dailySales); // Show all if filter is empty
                return;
            }

            let filtered = [...dailySales]; // Start with all sales

            if (startDateStr) {
                const startDate = new Date(startDateStr);
                // Set to start of the day to include all sales on that day
                startDate.setHours(0, 0, 0, 0); 
                filtered = filtered.filter(sale => new Date(sale.timestamp) >= startDate);
            }

            if (endDateStr) {
                const endDate = new Date(endDateStr);
                // Set to end of the day to include all sales on that day
                endDate.setHours(23, 59, 59, 999); 
                filtered = filtered.filter(sale => new Date(sale.timestamp) <= endDate);
            }
            
            if (filtered.length === 0) {
                showMessage('Sin Resultados', 'No se encontraron ventas para el rango de fechas seleccionado.');
            } else {
                showMessage('Filtro Aplicado', `Mostrando ${filtered.length} ventas.`);
            }
            renderDailySales(filtered);
        }

        function clearSalesFilter() {
            startDateInput.value = '';
            endDateInput.value = '';
            // Always render all sales when clearing filter, regardless of toggle state
            renderDailySales(dailySales); 
            showMessage('Filtro Limpiado', 'Se muestran todas las ventas.');
        }


        // --- WhatsApp Integration ---
        function sendWhatsAppConfirmation() {
            if (currentTransaction.length === 0) {
                showMessage('Transacci√≥n Vac√≠a', 'No hay productos en la transacci√≥n para enviar la confirmaci√≥n.');
                return;
            }

            const total = parseFloat(transactionTotalElement.textContent.replace('Total: $', ''));
            let message = "¬°Hola! Tu pedido de Capibobba ha sido confirmado:\n\n";
            let itemNumber = 1;

            currentTransaction.forEach(item => {
                let toppingsDetail = '';
                let itemTotalPricePerUnit = item.price; // Price of one unit of the drink
                if (item.toppings && item.toppings.length > 0) {
                    toppingsDetail = ` con ${item.toppings.map(t => t.name).join(', ')}`;
                    itemTotalPricePerUnit += item.toppings.reduce((sum, t) => sum + t.price, 0);
                }
                message += `${itemNumber}. ${item.quantity}x ${item.name}${toppingsDetail} ($${(itemTotalPricePerUnit * item.quantity).toFixed(2)})\n`;
                itemNumber++;
            });

            message += `\nTotal de tu pedido: $${total.toFixed(2)}`;
            message += `\n\nTu pago ser√° en efectivo? Te llevo cambio? O si prefieres por transferencia a la siguiente CLABE 722968010305501833`;
            message += `\n\n¬°Gracias por tu compra! üíñ`;

            const whatsappNumber = "5217712794633"; // N√∫mero de WhatsApp de Capibobba
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;

            const newWindow = window.open(whatsappUrl, '_blank');

            if (newWindow === null || typeof newWindow === 'undefined' || newWindow.closed) {
                console.error("Popup blocked or window could not be opened for WhatsApp.");
                showMessage('Error al Abrir WhatsApp', 'Parece que tu navegador bloque√≥ la ventana emergente. Por favor, permite pop-ups para enviar la confirmaci√≥n por WhatsApp.');
            } else {
                showMessage('Confirmaci√≥n Enviada', 'Se ha generado el mensaje de WhatsApp. Por favor, revisa la ventana emergente.');
            }
        }

        // --- Utility Functions ---

        // Shows a custom modal message
        function showMessage(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModalOverlay.classList.add('show');
        }

        // Hides the custom modal message
        function hideMessage() {
            modalCloseButton.removeEventListener('click', hideMessage); // Remove previous listener
            modalCloseButton.addEventListener('click', hideMessage); // Add it back to prevent multiple listeners
            messageModalOverlay.classList.remove('show');
        }

        // Shows a custom confirmation modal
        let onConfirmCallback = null; // Stores the callback for the confirm modal

        function showConfirm(title, message, callback) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            onConfirmCallback = callback; // Store the callback

            confirmModalOverlay.classList.add('show');
        }

        function hideConfirm() {
            confirmModalOverlay.classList.remove('show');
            onConfirmCallback = null; // Clear the callback
        }

        // Closes the topping selection modal and discards changes
        function cancelToppingSelection() {
            currentDrinkBeingCustomized = null; // Discard current selection
            toppingSelectionOverlay.classList.remove('show'); // Hide modal
        }

        // --- New Reporting Functions ---

        // Helper to format date as YYYY-MM-DD
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Helper to get the Monday of the week for a given date
        function getMondayOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0 for Sunday, 1 for Monday, ..., 6 for Saturday
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust if Sunday
            const monday = new Date(d.setDate(diff));
            monday.setHours(0, 0, 0, 0); // Normalize to start of day
            return monday;
        }

        function generateDailyReport() {
            const dailyTotals = new Map(); // Map<YYYY-MM-DD, total>

            dailySales.forEach(sale => {
                const saleDate = formatDate(sale.timestamp);
                const currentTotal = dailyTotals.get(saleDate) || 0;
                dailyTotals.set(saleDate, currentTotal + sale.total);
            });

            const report = Array.from(dailyTotals.entries()).map(([date, total]) => ({
                period: date,
                total: total
            }));

            // Sort by date ascending for report display
            report.sort((a, b) => new Date(a.period) - new Date(b.period));
            return report;
        }

        function generateWeeklyReport() {
            const weeklyTotals = new Map(); // Map<YYYY-MM-DD (Monday), total>

            dailySales.forEach(sale => {
                const mondayOfWeek = getMondayOfWeek(sale.timestamp);
                const weekKey = formatDate(mondayOfWeek); // Use Monday's date as key for the week
                const currentTotal = weeklyTotals.get(weekKey) || 0;
                weeklyTotals.set(weekKey, currentTotal + sale.total);
            });

            const report = Array.from(weeklyTotals.entries()).map(([weekStart, total]) => ({
                period: `Semana del ${weekStart}`,
                total: total
            }));

            // Sort by week start date ascending
            report.sort((a, b) => new Date(a.period.replace('Semana del ', '')) - new Date(b.period.replace('Semana del ', '')));
            return report;
        }

        function generateMonthlyReport() {
            const monthlyTotals = new Map(); // Map<YYYY-MM, total>

            dailySales.forEach(sale => {
                const d = new Date(sale.timestamp);
                const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const currentTotal = monthlyTotals.get(monthKey) || 0;
                monthlyTotals.set(monthKey, currentTotal + sale.total);
            });

            const report = Array.from(monthlyTotals.entries()).map(([month, total]) => ({
                period: month,
                total: total
            }));

            // Sort by month ascending
            report.sort((a, b) => a.period.localeCompare(b.period));
            return report;
        }

        function renderReport(reportType) {
            let reportData = [];
            let reportTitle = '';

            if (dailySales.length === 0) {
                reportContent.innerHTML = '<p style="text-align: center; color: #6b7280;">No hay ventas registradas para generar informes.</p>';
                return;
            }

            switch (reportType) {
                case 'daily':
                    reportData = generateDailyReport();
                    reportTitle = 'Informe de Ventas Diario';
                    break;
                case 'weekly':
                    reportData = generateWeeklyReport();
                    reportTitle = 'Informe de Ventas Semanal';
                    break;
                case 'monthly':
                    reportData = generateMonthlyReport();
                    reportTitle = 'Informe de Ventas Mensual';
                    break;
                default:
                    reportContent.innerHTML = '<p style="text-align: center; color: #6b7280;">Selecciona un tipo de informe para ver los resultados.</p>';
                    return;
            }

            let reportHtml = `<h3>${reportTitle}</h3>`;
            if (reportData.length > 0) {
                reportHtml += '<ul>';
                reportData.forEach(item => {
                    reportHtml += `<li><span>${item.period}</span><span>$${item.total.toFixed(2)}</span></li>`;
                });
                reportHtml += '</ul>';
            } else {
                reportHtml += '<p style="text-align: center; color: #6b7280;">No hay datos para este informe.</p>';
            }
            reportContent.innerHTML = reportHtml;
        }


        // --- Event Listeners ---
        completeSaleButton.addEventListener('click', completeSale);
        clearTransactionButton.addEventListener('click', clearTransaction);
        whatsappConfirmationButton.addEventListener('click', sendWhatsAppConfirmation);
        modalCloseButton.addEventListener('click', hideMessage);

        // Confirmation Modal Buttons
        confirmYesButton.addEventListener('click', () => {
            if (onConfirmCallback) {
                onConfirmCallback();
            }
            hideConfirm();
        });
        confirmNoButton.addEventListener('click', hideConfirm);


        // Topping Modal Event Listeners
        confirmToppingsButton.addEventListener('click', addCustomizedDrinkToTransaction);
        noToppingsButton.addEventListener('click', function() {
            // If "No Toppings" is clicked, ensure selectedToppings is empty and add to transaction
            if (currentDrinkBeingCustomized) {
                currentDrinkBeingCustomized.selectedToppings = [];
                addCustomizedDrinkToTransaction();
            }
        });
        cancelToppingsButton.addEventListener('click', cancelToppingSelection);

        // Quantity control buttons in topping modal
        decrementQuantityButton.addEventListener('click', () => {
            let quantity = parseInt(drinkQuantityInput.value, 10);
            if (quantity > 1) {
                drinkQuantityInput.value = quantity - 1;
                updateToppingModalTotalPriceDisplay(); // Update price when quantity changes
            }
        });

        incrementQuantityButton.addEventListener('click', () => {
            let quantity = parseInt(drinkQuantityInput.value, 10);
            drinkQuantityInput.value = quantity + 1;
            updateToppingModalTotalPriceDisplay(); // Update price when quantity changes
        });

        // Ensure quantity input is always at least 1 and updates price
        drinkQuantityInput.addEventListener('change', () => {
            let quantity = parseInt(drinkQuantityInput.value, 10);
            if (isNaN(quantity) || quantity < 1) {
                drinkQuantityInput.value = 1;
            }
            updateToppingModalTotalPriceDisplay(); // Update price when input changes
        });

        // Filter Event Listeners
        applyFilterButton.addEventListener('click', applySalesFilter);
        clearFilterButton.addEventListener('click', clearSalesFilter);

        // Toggle Filter Checkbox Event Listener
        toggleFilterCheckbox.addEventListener('change', () => {
            isFilterEnabled = toggleFilterCheckbox.checked;
            if (isFilterEnabled) {
                salesFilterControlsContainer.classList.remove('hidden');
                showMessage('Filtro Activado', 'Ahora puedes filtrar las ventas por fecha.');
                applySalesFilter(); // Apply filter if there are dates, or show all if dates are empty
            } else {
                salesFilterControlsContainer.classList.add('hidden');
                clearSalesFilter(); // Clear filter inputs and show all sales
                showMessage('Filtro Desactivado', 'Se muestran todas las ventas.');
            }
        });

        // Report Buttons Event Listeners
        dailyReportButton.addEventListener('click', () => renderReport('daily'));
        weeklyReportButton.addEventListener('click', () => renderReport('weekly'));
        monthlyReportButton.addEventListener('click', () => renderReport('monthly'));


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeData();
            renderMenu();
            updateTransactionDisplay();
            
            // Listen for the custom event indicating Firebase Auth is ready
            document.addEventListener('firebaseAuthReady', () => {
                // Update currentUserId from the global variable set by the Firebase script
                currentUserId = window.currentUserId;
                isAuthReady = window.isAuthReady;
                
                if (isAuthReady && window.db && currentUserId) { // Use window.db here
                    console.log("POS Script: Firebase Auth is ready. Setting up Firestore listener.");
                    console.log("POS Script: Current User ID:", currentUserId);
                    // Set up real-time listener for daily sales
                    // Usa la variable appId definida globalmente en el script de Firebase
                    const salesCollectionRef = collection(window.db, `artifacts/${window.appId}/users/${currentUserId}/dailySales`);
                    const q = query(salesCollectionRef, orderBy("timestamp", "desc")); // Order by timestamp descending

                    onSnapshot(q, (snapshot) => {
                        dailySales = []; // Clear current in-memory sales
                        snapshot.forEach((doc) => {
                            dailySales.push({ id: doc.id, ...doc.data() }); // Store doc.id
                        });
                        console.log("Firestore: Daily sales updated.", dailySales);
                        // When data updates, re-render based on current filter state
                        if (isFilterEnabled) {
                            applySalesFilter(); // Re-apply filter if active
                        } else {
                            renderDailySales(); // Show all if filter is disabled
                        }
                        // Also update reports if a report was previously generated
                        // This might be too aggressive, consider only updating if the report section is visible
                        // For now, let's keep it simple and assume user will click report button again
                        // if (reportContent.innerHTML !== '<p style="text-align: center; color: #6b7280;">Selecciona un tipo de informe para ver los resultados.</p>') {
                        //     // Re-render the last active report type (if we track it)
                        // }
                    }, (error) => {
                        console.error("Firestore: Error fetching daily sales:", error);
                        showMessage('Error de Sincronizaci√≥n', `No se pudieron cargar las ventas diarias desde la base de datos: ${error.message}.`);
                    });
                } else {
                    console.warn("POS Script: Firebase or userId not ready, cannot set up Firestore listener. Displaying local data only.");
                    renderDailySales(); // Render empty list or previous local data
                }
            });
        });
    </script>
</body>
</html>

